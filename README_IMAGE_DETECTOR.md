# 悬浮窗口图像检测工具

## 项目简介

这是一个基于Python开发的桌面应用程序，用于实时检测屏幕上是否包含指定的参考图像。程序提供了一个可移动的悬浮窗口界面，用户可以点击按钮启动或停止检测功能。当检测到目标界面时，程序会在悬浮窗口中显示检测结果。

## 功能特点

- 🎯 **可移动悬浮窗口**：程序运行后显示一个可拖动的悬浮窗口
- 🖱️ **一键检测**：点击按钮即可启动或停止实时检测
- 📸 **实时屏幕捕获**：自动捕获当前屏幕画面进行分析
- 🔍 **高相似度图像比对**：使用模板匹配算法进行精确的图像比对
- ✅ **智能界面识别**：检测当前屏幕是否包含所有参考图像
- 🎨 **直观的结果显示**：在悬浮窗口中清晰显示检测结果
- ⚡ **高性能设计**：优化的算法确保实时检测不卡顿
- 🛡️ **用户友好**：提供退出按钮和ESC快捷键

## 技术架构

- **开发语言**：Python 3.8+
- **GUI框架**：Tkinter（Python内置）
- **图像处理**：OpenCV (cv2)
- **屏幕截图**：PyAutoGUI
- **数值计算**：NumPy
- **图像转换**：Pillow (PIL)
- **多线程处理**：Python threading模块

## 安装指南

### 1. 安装Python

确保你的系统已安装Python 3.8或更高版本。你可以从[Python官网](https://www.python.org/downloads/)下载并安装。

### 2. 下载项目文件

下载以下项目文件到本地目录：

- `floating_image_detector.py`：主程序文件
- `requirements.txt`：依赖包列表
- `img/test/course_menu/`：参考图像目录

### 3. 安装依赖包

打开命令行终端，进入项目目录，执行以下命令安装所需的依赖包：

```bash
pip install -r requirements.txt
```

依赖包包括：
- pyautogui：用于屏幕截图
- opencv-python：用于图像处理和模板匹配
- numpy：用于数值计算
- pillow：用于图像格式转换

## 使用方法

### 1. 准备参考图像

将需要检测的图像文件放置在 `img/test/course_menu/` 目录下，目前支持的图像格式包括：PNG、JPG、JPEG。

### 2. 启动程序

在项目目录下执行以下命令启动悬浮图像检测工具：

```bash
python floating_image_detector.py
```

### 3. 使用悬浮窗口

程序启动后，屏幕上会显示一个半透明的悬浮窗口，包含以下元素：

- **标题**："图像检测工具"
- **状态显示**：显示当前检测结果，初始状态为"当前界面：未检测"
- **开始检测按钮**：点击启动实时检测
- **退出按钮**：关闭程序

### 4. 移动悬浮窗口

你可以通过拖动悬浮窗口的任意位置来移动它，方便在不同场景下使用。

### 5. 开始检测

1. 点击悬浮窗口中的"开始检测"按钮
2. 程序会自动执行以下操作：
   - 实时捕获当前屏幕画面
   - 对屏幕画面与参考图像进行模板匹配
   - 检查是否所有参考图像都在当前屏幕上
3. 检测过程中，按钮文本会变为"停止检测"

### 6. 检测结果说明

- **检测到目标界面**：如果当前屏幕包含所有参考图像，窗口背景会变为绿色，状态显示为"当前界面：course menu"
- **未检测到目标界面**：如果缺少任何一个参考图像，窗口保持默认颜色，状态显示为"当前界面：未检测"

### 7. 停止检测

点击悬浮窗口中的"停止检测"按钮即可停止实时检测。

### 8. 退出程序

有两种方式退出程序：
1. 点击悬浮窗口中的"退出"按钮
2. 按键盘上的ESC键

## 工作原理

### 1. 图像捕获

使用PyAutoGUI库对当前屏幕进行全屏截图，获取像素数据。

### 2. 模板匹配

采用OpenCV的模板匹配算法（cv2.matchTemplate）进行图像比对，具体步骤：

1. 将屏幕截图和参考图像转换为灰度图，提高匹配速度和准确性
2. 使用TM_CCOEFF_NORMED方法计算匹配度
3. 设置相似度阈值（默认85%），过滤低匹配度结果
4. 检查是否所有参考图像都能在屏幕上找到匹配

### 3. 多线程设计

为了确保用户界面的响应性，程序采用多线程设计：

- **主线程**：负责创建和管理GUI界面
- **检测线程**：在后台执行实时屏幕检测

### 4. 性能优化

- 使用灰度图像进行匹配，减少计算量
- 控制检测频率（每0.3秒检测一次），避免CPU占用过高
- 采用高效的模板匹配算法，确保实时性

## 配置说明

### 相似度阈值

在程序中，模板匹配的相似度阈值默认为0.85（85%）。如果需要调整，可以修改`match_template`方法中的`threshold`参数：

```python
def match_template(self, screen_gray, template, threshold=0.85):
    # 模板匹配代码
```

### 检测频率

检测频率控制在`detect_screen`方法中，默认每0.3秒检测一次：

```python
def detect_screen(self):
    while self.is_detecting:
        # 检测代码
        time.sleep(0.3)  # 控制检测频率
```

## 参考图像管理

参考图像存储在`img/test/course_menu/`目录下，程序会自动加载该目录中的所有PNG、JPG、JPEG格式的图像文件。

### 添加新的参考图像

1. 准备需要检测的图像
2. 将图像文件复制到`img/test/course_menu/`目录
3. 重新启动程序即可自动加载新的参考图像

### 移除参考图像

1. 从`img/test/course_menu/`目录中删除不需要的图像文件
2. 重新启动程序即可应用更改

## 错误处理

程序包含完善的错误处理机制，可以处理以下异常情况：

- **屏幕捕获错误**：当无法获取屏幕画面时，会跳过当前检测周期
- **图像匹配错误**：当模板匹配失败时，会记录错误并继续运行
- **依赖缺失**：程序启动时会检查必要的依赖包，如果缺少会给出提示

## 系统要求

- **操作系统**：Windows 7/8/10/11，macOS，Linux
- **Python版本**：Python 3.8或更高版本
- **硬件要求**：
  - CPU：双核或更高性能处理器
  - 内存：2GB或更多
  - 屏幕分辨率：支持任意分辨率

## 注意事项

1. **性能考虑**：长时间运行实时检测可能会增加系统资源消耗
2. **参考图像选择**：建议选择界面中稳定、独特的元素作为参考图像
3. **分辨率影响**：如果屏幕分辨率与参考图像的分辨率差异较大，可能会影响匹配效果
4. **窗口遮挡**：如果参考图像区域被其他窗口遮挡，检测可能会失败
5. **权限要求**：在某些系统上，可能需要管理员权限才能正常截图

## 常见问题

### Q: 程序启动时提示缺少依赖包怎么办？
A: 运行 `pip install -r requirements.txt` 命令安装所有必要的依赖包。

### Q: 为什么检测不到应该存在的界面？
A: 请检查以下几点：
1. 确保所有参考图像都在当前屏幕上可见
2. 检查屏幕分辨率是否与参考图像的分辨率相差太大
3. 尝试调整模板匹配的相似度阈值

### Q: 程序运行时CPU占用很高怎么办？
A: 可以通过增加`detect_screen`方法中的`sleep`时间来降低检测频率，减少CPU占用。

### Q: 为什么悬浮窗口无法正常显示或移动？
A: 请确保你的系统支持Tkinter窗口的透明效果和置顶功能。在某些系统上，可能需要特殊权限。

## 开发与扩展

### 核心类和方法

- **FloatingImageDetector**：主程序类，负责创建和管理悬浮窗口界面
- **load_reference_images**：加载参考图像
- **capture_screen**：捕获当前屏幕画面
- **match_template**：使用模板匹配算法进行图像比对
- **detect_screen**：检测屏幕上是否包含所有参考图像
- **toggle_detection**：切换检测状态（开始/停止）

### 扩展方向

如果你想扩展这个项目，可以考虑以下方向：

1. **支持更多界面类型**：扩展程序以支持检测多种不同类型的界面
2. **自定义参考图像**：添加功能允许用户选择自己的参考图像
3. **匹配结果可视化**：在屏幕上标记出匹配到的参考图像位置
4. **批量检测**：支持对多个屏幕或窗口进行批量检测
5. **热键支持**：添加键盘热键快速执行常用操作
6. **结果记录**：将检测结果保存到日志文件

## 版本历史

### v1.0.0（当前版本）
- ✨ 初始版本发布
- 🎯 实现可移动悬浮窗口界面
- 🖱️ 添加开始/停止检测按钮
- 📸 集成屏幕截图功能
- 🔍 实现模板匹配算法
- ✅ 支持多参考图像检测
- 🎨 添加直观的结果显示
- ⚡ 优化性能，确保实时检测
- 🛡️ 添加完善的错误处理

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 提交Issue：通过项目仓库提交问题
- 发送邮件：[你的邮箱地址]

---

**享受使用悬浮窗口图像检测工具！** 🚀