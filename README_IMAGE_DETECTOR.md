# 悬浮窗口界面检测工具 (Floating Interface Detector)

## 项目简介

悬浮窗口界面检测工具是一款基于Python开发的桌面应用程序，提供直观的悬浮窗口界面，能够实时监控屏幕并识别多种不同的界面类型。该工具适用于需要自动识别和响应不同软件界面的场景，如自动化测试、界面监控、应用程序状态跟踪等。

## 功能特点

- **可移动悬浮窗口**：支持拖动窗口任意位置，方便用户灵活放置。
- **一键检测**：通过简单的按钮操作即可开始或停止屏幕检测。
- **实时屏幕捕获与分析**：持续监控屏幕内容，快速响应界面变化。
- **多界面类型支持**：自动识别"img/test"路径下所有子文件夹中定义的界面类型。
- **智能参考图像加载**：自动加载所有子文件夹中的图像作为参考模板。
- **高相似度匹配**：使用85%以上的相似度阈值，确保匹配结果的准确性。
- **抗干扰能力**：具备抗分辨率变化、位置偏移和轻微噪声的能力。
- **特殊情况处理**：支持自定义特殊界面的优先级处理规则（如course_starts优先于course_not_started）。
- **智能界面识别**：根据匹配到的参考图像自动识别当前界面类型。
- **清晰结果显示**：在悬浮窗口中以友好格式显示当前检测结果。
- **优雅退出**：支持点击按钮或按ESC键安全退出程序。
- **完善的错误处理**：具备异常捕获和错误提示功能，确保程序稳定性。

## 技术架构

- **开发语言**：Python 3.8+
- **GUI框架**：Tkinter（Python内置）
- **图像处理**：OpenCV (cv2)
- **屏幕截图**：PyAutoGUI
- **数值计算**：NumPy
- **图像转换**：Pillow (PIL)
- **多线程处理**：Python threading模块

## 安装指南

### 1. 安装Python

确保你的系统已安装Python 3.8或更高版本。你可以从[Python官网](https://www.python.org/downloads/)下载并安装。

### 2. 下载项目文件

下载以下项目文件到本地目录：

- `floating_image_detector.py`：主程序文件
- `requirements.txt`：依赖包列表
- `img/test/`：参考图像目录（包含子文件夹）

### 3. 安装依赖包

打开命令行终端，进入项目目录，执行以下命令安装所需的依赖包：

```bash
pip install -r requirements.txt
```

依赖包包括：
- pyautogui：用于屏幕截图
- opencv-python：用于图像处理和模板匹配
- numpy：用于数值计算
- pillow：用于图像格式转换

## 使用方法

### 1. 准备参考图像

在项目根目录下的`img/test`文件夹中创建子文件夹，每个子文件夹代表一种界面类型：

```
img/test/
├── course_menu/        # 课程菜单界面
│   ├── 001.PNG
│   ├── 002.PNG
│   └── 003.PNG
├── course_not_started/ # 课程未开始界面
│   ├── 004.PNG
│   ├── 005.PNG
│   └── 006.PNG
├── course_starts/      # 课程开始界面
│   └── join.PNG
└── 其他界面类型文件夹...
```

将需要检测的图像文件放置在对应的子文件夹下，支持的图像格式包括：PNG、JPG、JPEG。

### 2. 启动程序

在项目目录下执行以下命令启动悬浮界面检测工具：

```bash
python floating_image_detector.py
```

### 3. 使用悬浮窗口

程序启动后，屏幕上会显示一个半透明的悬浮窗口，包含以下元素：

- **标题**："图像检测工具"
- **状态显示**：显示当前检测结果，初始状态为"当前界面：未检测"
- **开始检测按钮**：点击启动实时检测
- **退出按钮**：关闭程序

### 4. 移动悬浮窗口

你可以通过拖动悬浮窗口的任意位置来移动它，方便在不同场景下使用。

### 5. 开始检测

1. 点击悬浮窗口中的"开始检测"按钮
2. 程序会自动执行以下操作：
   - 实时捕获当前屏幕画面
   - 对屏幕画面与所有参考图像进行模板匹配
   - 检查当前界面匹配的类型
3. 检测过程中，按钮文本会变为"停止检测"

### 6. 检测结果说明

- **检测到目标界面**：如果当前屏幕匹配某个界面类型的所有参考图像，窗口背景会变为绿色，状态显示为对应的界面名称（如"当前界面：Course Menu"）
- **未检测到目标界面**：如果不匹配任何界面类型，窗口保持默认颜色，状态显示为"当前界面：未检测"

### 7. 停止检测

点击悬浮窗口中的"停止检测"按钮即可停止实时检测。

### 8. 退出程序

有两种方式退出程序：
1. 点击悬浮窗口中的"退出"按钮
2. 按键盘上的ESC键

## 界面识别规则

### 基本识别逻辑
- 程序会检测当前界面是否存在与"img/test"路径下任何文件夹中图片的高相似度匹配
- 当检测到匹配图片时，将当前界面命名为该图片所在文件夹的名称
- 例如：如果检测到"img/test/course_menu"文件夹中的图片匹配，界面将被识别为"Course Menu"

### 特殊情况处理
- **课程界面优先级规则**：
  - 当当前界面同时匹配"course_not_started"和"course_starts"两个文件夹中的图片时，判定为"Course Starts"
  - 当当前界面仅匹配"course_not_started"文件夹中的图片，且未匹配"course_starts"文件夹中的图片时，判定为"Course Not Started"

### 界面名称显示
- 识别出的界面名称会在浮窗上以友好格式显示，例如：
  - "course_menu" → "Course Menu"
  - "course_not_started" → "Course Not Started"
  - "poll_starts" → "Poll Starts"

## 工作原理

### 1. 参考图像加载

程序启动时，会自动扫描`img/test`路径下的所有子文件夹：

- 每个子文件夹被视为一种界面类型
- 加载其中所有图像作为参考模板
- 将参考图像转换为灰度图并进行轻微高斯模糊处理，提高匹配稳定性

### 2. 屏幕捕获

使用PyAutoGUI库对当前屏幕进行全屏截图，获取像素数据：

- 定期捕获当前屏幕画面（约3次/秒）
- 将捕获的画面转换为灰度图并进行轻微高斯模糊，减少噪声影响

### 3. 多模板匹配

采用OpenCV的模板匹配算法（cv2.matchTemplate）进行图像比对，具体步骤：

1. 使用TM_CCOEFF_NORMED方法计算匹配度
2. 设置相似度阈值（默认85%），过滤低匹配度结果
3. 检查是否所有参考图像都能在屏幕上找到高相似度匹配

### 4. 界面识别逻辑

基于匹配结果确定当前界面类型：

1. 如果一个界面类型的所有参考图像都匹配成功，则识别为该类型
2. 应用特殊界面处理规则（如course_starts优先于course_not_started）
3. 将识别结果转换为友好的显示格式

### 5. 多线程设计

为了确保用户界面的响应性，程序采用多线程设计：

- **主线程**：负责创建和管理GUI界面
- **检测线程**：在后台执行实时屏幕检测

### 6. 性能优化

- 使用灰度图像进行匹配，减少计算量
- 控制检测频率（每0.3秒检测一次），避免CPU占用过高
- 采用高效的模板匹配算法，确保实时性
- 对图像进行预处理，提高匹配稳定性

## 配置说明

### 主要参数

- **参考图像基础路径**：`img/test` - 存放所有界面类型参考图像的基础文件夹
- **相似度阈值**：85% - 用于判断图像匹配的最小相似度
- **检测频率**：约3次/秒 - 控制屏幕捕获和匹配的频率
- **特殊界面配置**：`course_not_started`和`course_starts` - 具有特殊优先级处理的界面类型

### 自定义配置

如果需要修改程序的默认配置，可以在`floating_image_detector.py`文件中修改以下参数：

```python
# 相似度阈值（0-1之间）
threshold = 0.85

# 检测频率（秒）
detection_interval = 0.3

# 特殊界面配置
special_interfaces = {
    "course_not_started": False,
    "course_starts": False
}
```

## 参考图像管理

### 添加新的界面类型

1. 在`img/test`文件夹中创建一个新的子文件夹，以界面类型命名（如`new_interface_type`）
2. 将该界面类型的参考图像添加到新创建的文件夹中
3. 重新启动程序，新的界面类型将自动被识别和支持

### 添加新的参考图像

1. 将新的参考图像添加到对应的界面类型子文件夹中（如`img/test/course_menu/`）
2. 确保图像格式为支持的格式（PNG、JPG、JPEG）
3. 重新启动程序，新的参考图像将自动被加载

### 移除参考图像

1. 从对应的界面类型子文件夹中删除不需要的图像文件
2. 重新启动程序即可应用更改

## 错误处理

程序包含完善的错误处理机制，可以处理以下异常情况：

- **屏幕捕获错误**：当无法获取屏幕画面时，会跳过当前检测周期
- **图像匹配错误**：当模板匹配失败时，会记录错误并继续运行
- **依赖缺失**：程序启动时会检查必要的依赖包，如果缺少会给出提示
- **文件读取错误**：处理参考图像加载失败的情况

## 系统要求

- **操作系统**：Windows 7/8/10/11，macOS，Linux
- **Python版本**：Python 3.8或更高版本
- **硬件要求**：
  - CPU：双核或更高性能处理器
  - 内存：2GB或更多
  - 屏幕分辨率：支持任意分辨率

## 注意事项

1. **性能考虑**：长时间运行实时检测可能会增加系统资源消耗
2. **参考图像选择**：建议选择界面中稳定、独特的元素作为参考图像
3. **分辨率影响**：如果屏幕分辨率与参考图像的分辨率差异较大，可能会影响匹配效果
4. **窗口遮挡**：如果参考图像区域被其他窗口遮挡，检测可能会失败
5. **权限要求**：在某些系统上，可能需要管理员权限才能正常截图
6. **特殊界面规则**：了解并正确配置特殊界面的优先级规则

## 常见问题

### Q: 程序启动时提示缺少依赖包怎么办？
A: 运行 `pip install -r requirements.txt` 命令安装所有必要的依赖包。

### Q: 为什么检测不到应该存在的界面？
A: 请检查以下几点：
1. 确保所有参考图像都在当前屏幕上可见
2. 检查屏幕分辨率是否与参考图像的分辨率相差太大
3. 尝试调整模板匹配的相似度阈值
4. 确认参考图像的文件名和路径正确

### Q: 程序运行时CPU占用很高怎么办？
A: 可以通过增加`detect_screen`方法中的`sleep`时间来降低检测频率，减少CPU占用。

### Q: 为什么悬浮窗口无法正常显示或移动？
A: 请确保你的系统支持Tkinter窗口的透明效果和置顶功能。在某些系统上，可能需要特殊权限。

### Q: 如何添加新的界面类型？
A: 在`img/test`文件夹中创建新的子文件夹，并添加对应的参考图像，重新启动程序即可。

### Q: 特殊界面的优先级规则是什么？
A: 当同时匹配"course_not_started"和"course_starts"时，系统会优先识别为"Course Starts"。

## 开发与扩展

### 核心类和方法

- **FloatingImageDetector**：主程序类，负责创建和管理悬浮窗口界面
- **load_reference_images**：加载所有界面类型的参考图像
- **capture_screen**：捕获当前屏幕画面
- **match_template**：使用模板匹配算法进行图像比对
- **detect_screen**：检测屏幕上匹配的界面类型
- **toggle_detection**：切换检测状态（开始/停止）
- **_handle_special_cases**：处理特殊界面优先级规则
- **_format_interface_name**：将界面名称转换为友好格式

### 扩展方向

如果你想扩展这个项目，可以考虑以下方向：

1. **支持更多界面类型**：扩展程序以支持检测更多不同类型的界面
2. **自定义参考图像**：添加功能允许用户选择自己的参考图像
3. **匹配结果可视化**：在屏幕上标记出匹配到的参考图像位置
4. **批量检测**：支持对多个屏幕或窗口进行批量检测
5. **热键支持**：添加键盘热键快速执行常用操作
6. **结果记录**：将检测结果保存到日志文件
7. **扩展特殊规则**：添加更多自定义的特殊界面处理规则

## 测试工具

项目包含一个专门的测试脚本`test_detector_logic.py`，用于验证核心功能：

```bash
python test_detector_logic.py
```

测试内容包括：
- 参考图像加载验证
- 特殊界面处理逻辑测试
- 界面名称格式化测试

## 版本历史

### v2.0.0（当前版本）
- ✨ 重大功能升级：支持多界面类型识别
- 🎯 新增特殊界面优先级处理逻辑
- 🔍 改进图像匹配算法，提高识别准确性
- 📸 优化屏幕捕获和图像处理流程
- 🛡️ 增强错误处理和异常恢复能力
- 📋 添加详细的测试工具和文档
- 🎨 优化用户界面和结果显示

### v1.0.0
- ✨ 初始版本发布
- 🎯 实现可移动悬浮窗口界面
- 🖱️ 添加开始/停止检测按钮
- 📸 集成屏幕截图功能
- 🔍 实现模板匹配算法
- ✅ 支持多参考图像检测
- 🎨 添加直观的结果显示
- ⚡ 优化性能，确保实时检测
- 🛡️ 添加完善的错误处理

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 提交Issue：通过项目仓库提交问题
- 发送邮件：[你的邮箱地址]

---

**享受使用悬浮窗口界面检测工具！** 🚀